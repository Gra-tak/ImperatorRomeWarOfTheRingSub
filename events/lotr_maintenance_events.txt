namespace = lotr_maintenance

#Various maintenance events

		
lotr_maintenance.1 = { 
	
	type = country_event
  title = "lotr_maintenance.1.t"
  desc = "lotr_maintenance.1.desc"
  picture = event_orcs_orcs

	trigger = {
    country_culture_group  = orcs_group
    war = no
    any_unit = {
      has_variable = displaced_orcs
    }
	}
	
	immediate = {
	}
	
	option = {
		name = "OK"	
    set_variable = {
      name = num_orcs
      value = 0
    }
    every_unit = {
      limit = {
        has_variable = displaced_orcs
      }
      every_sub_unit = {
        ROOT = {
          change_variable = {
            name = num_orcs
            add = 1
          }
        }
      }
      destroy_unit = yes
    }
    while = {
      limit = { var:num_orcs > 3 }
      random_owned_province = {
        limit = {
          total_population < population_cap
        }
        define_pop = {
          type = slaves
          culture = root.culture
          religion = root.religion
        }
      }
      change_variable = {
        name = num_orcs
        subtract = 6
      }
    }
    ai_chance = {
      base = 100
    }
	}
  option = {
    name = "lotr_maintenance.1.b" 
    ai_chance = {
      base = 0
    }
  }
}


#pseudo diloyal vassals in civil wars
lotr_maintenance.2 = { 
  type = country_event
  hidden = yes
  trigger = {
    OR = {
      tag = GON
      tag = CAR
      tag = ARN
    }
    has_civil_war = yes
  }
  immediate = {
    every_current_war = {
      limit = { is_civil_war = yes }
      every_war_participant = {
        limit = {
          OR = {
            is_subject_type = satrapy
            is_subject_type = ranger_protectorate
          }
        }
        add_to_list = fighting_subjects
        PREV = {
          remove_from_war = PREV.PREV
        }
      }
    }
    every_in_list = {
      list = fighting_subjects
      overlord = { release_subject = PREV }
      ROOT = {
        if = { 
          limit = { THIS = c:GON }
          make_subject = {
            target = PREV
            type = satrapy
          }
        }
        else
        {
          make_subject = {
            target = PREV
            type = ranger_protectorate
          }
        }
      }
    }
  }
}

#accept cultures for AI (somehow they seem to fail to use the cultural decision)
lotr_maintenance.3 = { 
  type = country_event
  title = OK
  desc = OK
  hidden = yes
  trigger = {
    is_ai = yes
  }
  immediate = {
    every_country_culture = {
      limit = {
        is_integrated = no
        NOT = { culture = culture:urukhai }
        culture.culture_group = ROOT.culture_group
        country_culture_pop_count > ROOT.twenty_percent_integrated_pops
      }
      ROOT = { integrate_country_culture = PREV }
    }
  }
  option = {
    name = OK
  }
}

#mark provinces near orcs for raids.
lotr_maintenance.4 = { 
  type = country_event
  hidden = yes
  trigger = {
    is_ai = no
  }
  immediate = {
    every_region = {
      limit = {
        any_region_province = {
          has_owner = yes
          owner = {
            primary_culture = goblins
          }
        }
      }
      every_region_province = {
        limit = {
          OR = {
            has_owner = no
            owner = { religion = melkorism }
          }
        }
        set_variable = {
          name = hasGoblinsRaidsFlag
          days = 365
        }
      }
    }
    every_region = {
      limit = {
        any_region_province = {
          has_owner = yes
          owner = {
            primary_culture = orcish
          }
        }
      }
      every_region_province = {
        limit = {
          OR = {
            has_owner = no
            owner = { religion = melkorism }
          }
        }
        set_variable = {
          name = hasOrcRaidsFlag
          days = 365
        }
      }
    }
    every_region = {
      limit = {
        any_region_province = {
          has_owner = yes
          owner = {
            primary_culture = urukhai
          }
        }
      }
      every_region_province = {
        limit = {
          OR = {
            has_owner = no
            owner = { religion = melkorism }
          }
        }
        set_variable = {
          name = hasUrukRaidsFlag
          days = 365
        }
      }
    }
    every_country = {
      limit = {
        NOT = { religion = melkorism }
        is_ai = no
      }
      set_variable = {
        name = golbin_raid_province_num
        value = country_count_possibly_raided_provinces_goblins
      }
      set_variable = {
        name = orc_raid_province_num
        value = country_count_possibly_raided_provinces_orcs
      }
      set_variable = {
        name = uruk_raid_province_num
        value = country_count_possibly_raided_provinces_uruk
      }
    }
  }
}

#mark provinces near corsairs for raids.
lotr_maintenance.5 = { 
  type = country_event
  title = OK
  desc = OK
  hidden = yes
  trigger = {
    tag = UMB
  }
  immediate = {
    # capital_scope.region = {
    # }
    if = {
      limit = { NOT = { has_variable = rivers_marked_flag } }
      every_sea_and_river_zone = {
        limit = {
          is_sea = no
        }
        set_variable = {
          name = is_a_river
        }
      }
      set_variable = {
        name = rivers_marked_flag
      }
    }
    every_owned_province = {
      limit = {
        is_coastal = yes
      }
      every_neighbor_province = {
        limit = {
          OR = {
            is_sea = yes
            has_variable = is_a_river
          }
          NOT = {
            is_in_list = raidSeaZones
          }
        }
        add_to_list = raidSeaZones
      }
    }
    every_subject = {
      every_owned_province = {
        limit = {
          is_coastal = yes
        }
        every_neighbor_province = {
          limit = {
            OR = {
              is_sea = yes
              has_variable = is_a_river
            }
            NOT = {
              is_in_list = raidSeaZones
            }
          }
          add_to_list = raidSeaZones
        }
      }
    }
    if = {
      limit = {
        military_tech > 20
      }
      set_local_variable = {
        name = currentDistance
        value = 0
      }
    }
    else_if = {
      limit = {
        military_tech > 16
      }
      set_local_variable = {
        name = currentDistance
        value = 1
      }
    }
    else_if = {
      limit = {
        military_tech > 12
      }
      set_local_variable = {
        name = currentDistance
        value = 2
      }
    }
    else_if = {
      limit = {
        military_tech > 8
      }
      set_local_variable = {
        name = currentDistance
        value = 3
      }
    }
    else_if = {
      limit = {
        military_tech > 4
      }
      set_local_variable = {
        name = currentDistance
        value = 4
      }
    }
    else
    {
      set_local_variable = {
        name = currentDistance
        value = 5
      }
    }
    while = {
      count = 10 #maximum with high military tech. Probably not needed but let's make sure the game doesn't go infinite loop
      limit = {
        local_var:currentDistance < 10
      }
      change_local_variable = {
        name = currentDistance
        add = 1
      }
      every_in_list = {
        list = raidSeaZones
        limit = {
          NOT = { has_variable = corsairRaidDistance }
        }
        set_variable = {
          name = corsairRaidDistance
          value = local_var:currentDistance
          days = 364
        }
        every_neighbor_province = {
          limit = {
            NOR = {
              is_in_list = raidSeaZones
              has_variable = corsairRaidDistance
              this = p:5499 #impassable part of the sea
            }
            OR = {
              is_sea = yes
              has_variable = is_a_river
            }
          }
          add_to_list = raidSeaZones
        }
      }
    }
    every_country = {
      limit = {
        NOT = { religion = melkorism }
        any_owned_province = {
          OR = {
            can_build_building = port_building
            num_of_port_building >= 1
          }
        }
        any_owned_province = {
          any_neighbor_province = {
            has_variable = corsairRaidDistance
          }
          NOR = { 
            has_building = fortress_building
            has_variable = protected_against_corsairs
          }
        }
      }
      set_local_variable = {
        name = corsair_raid_strength_total
        value = 0
      }
      every_owned_province = {
        limit = {
          any_neighbor_province = {
            has_variable = corsairRaidDistance
          }
          NOR = { 
            has_building = fortress_building
            has_variable = protected_against_corsairs
          }
        }
        # set_local_variable = {
        #   name = corsair_distance
        #   value = 10
        # }
        ordered_neighbor_province = {
          limit = { has_variable = corsairRaidDistance }
          order_by = {
            value = 11
            subtract = var:corsairRaidDistance
          }
          position = 0
          set_local_variable = {
            name = corsair_distance
            value = var:corsairRaidDistance
          }
        }
        set_variable = {
          name = corsair_raid_strength
          value = 11
          # subtract = local_var:corsair_distance
          days = 365
        }
        change_variable = {
          name = corsair_raid_strength
          subtract = local_var:corsair_distance
        }
        change_local_variable = {
          name = corsair_raid_strength_total
          add = var:corsair_raid_strength
        }
      }
      set_variable = {
        name = corsair_raid_strength_total
        value = local_var:corsair_raid_strength_total
        days = 365
      }
      change_variable = {
        name = corsair_raid_strength_total
        divide = 2 #todo check examples if this is reasonable
      }
      set_variable = {
        name = corsair_raid_strength_half
        value = var:corsair_raid_strength_total
        days = 365
      }
      change_variable = {
        name = corsair_raid_strength_half
        divide = 2
      }
      set_variable = {
        name = corsair_raid_strength_quarter
        value = var:corsair_raid_strength_half
        days = 365
      }
      change_variable = {
        name = corsair_raid_strength_quarter
        divide = 2
      }
      # round_variable = {
      #   name = corsair_raid_strength_total
      # }
    }
    every_country = {
      limit = { 
        any_subject = {
          has_variable = corsair_raid_strength_total
          num_of_ships < var:corsair_raid_strength_total
        } 
      }
      if = {
        limit = { has_variable = corsair_raid_strength_total }
        set_local_variable = {
          name = corsair_raid_strength_with_subjects
          value = var:corsair_raid_strength_total
        }
      }
      else = {
        set_local_variable = {
          name = corsair_raid_strength_with_subjects
          value = 0
        }
      }
      every_subject = {
        limit = {
          has_variable = corsair_raid_strength_total
        }
        if = {
          limit = {
            num_of_ships < var:corsair_raid_strength_quarter
          }
          change_local_variable = {
            name = corsair_raid_strength_with_subjects
            add = var:corsair_raid_strength_total
          }
          set_variable = {
            name = corsair_raid_strength_subject
            value = var:corsair_raid_strength_total
            days = 365
          }
        }
        else_if = {
          limit = {
            num_of_ships < var:corsair_raid_strength_half
          }
          change_local_variable = {
            name = corsair_raid_strength_with_subjects
            add = var:corsair_raid_strength_half
          }
          set_variable = {
            name = corsair_raid_strength_subject
            value = var:corsair_raid_strength_half
            days = 365
          }
        }
        else_if = {
          limit = {
            num_of_ships < var:corsair_raid_strength_total
          }
          change_local_variable = {
            name = corsair_raid_strength_with_subjects
            add = var:corsair_raid_strength_quarter
          }
          set_variable = {
            name = corsair_raid_strength_subject
            value = var:corsair_raid_strength_quarter
            days = 365
          }
        }
      }
      set_variable = {
        name = corsair_raid_strength_with_subjects
        value = local_var:corsair_raid_strength_with_subjects
        days = 365
      }
      change_variable = {
        name = corsair_raid_strength_with_subjects
        divide = 2 #todo check examples if this is reasonable
      }
      set_variable = {
        name = corsair_raid_strength_with_subjects_half
        value = var:corsair_raid_strength_with_subjects
        days = 365
      }
      change_variable = {
        name = corsair_raid_strength_with_subjects_half
        divide = 2
      }
      set_variable = {
        name = corsair_raid_strength_with_subjects_quarter
        value = var:corsair_raid_strength_with_subjects_half
        days = 365
      }
      change_variable = {
        name = corsair_raid_strength_with_subjects_quarter
        divide = 2
      }
      # round_variable = {
      #   name = corsair_raid_strength_with_subjects
      # }
    }
  }

  option = {
    name = OK
    # every_province = {
    #   limit = { 
    #     has_variable = corsair_raid_strength
    #     exists = owner
    #     NOT = { owner = ROOT }
    #   }
    #   set_conquered_by = ROOT
    }
    # every_in_list = {
    #   list = raidSeaZones
    #   every_neighbor_province = {
    #     limit = { 
    #       exists = owner
    #       NOT = { owner = ROOT }
    #     }
    #     set_conquered_by = ROOT
    #   }
    # }
  }
  # immediate = {
  #   # capital_scope.region = {
  #   # }
  #   every_owned_province = {
  #     limit = {
  #       is_coastal = yes
  #     }
  #     region = {
  #       if = {
  #         limit = {
  #           NOT = {
  #             is_in_list = raidRegions
  #           }
  #         }
  #         add_to_list = raidRegions
  #       }
  #     }
  #   }
  #   while = {
  #     count = 5
  #     every_in_list = {
  #       list = raidRegions
  #       every_neighbor_region = {
  #         limit = {
  #           NOT = {
  #             is_in_list = raidRegions
  #           }
  #           any_region_province = {
  #             is_coastal = yes
  #           }
  #         }
  #         add_to_list = raidRegions
  #       }
  #     }
  #   }
  # }

  # option = {
  #   name = OK
  #   every_in_list = {
  #     list = raidRegions
  #     every_region_province = {
  #       limit = { 
  #         exists = owner
  #         NOT = { owner = ROOT }
  #       }
  #       set_conquered_by = ROOT
  #     }
  #   }
  # }
}